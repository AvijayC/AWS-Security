# S3 Security Lab Notes

## KMS Encryption with S3 - Deep Dive

### Understanding KMS Keys vs Data Keys

#### KMS Keys (Customer Master Keys - CMKs)
• **Never leave KMS** - stored and used only within KMS hardware security modules  
• Identified by ARN: `arn:aws:kms:region:account:key/key-id`  
• Can encrypt/decrypt up to 4KB of data directly  
• Used to generate and encrypt data keys  
• Controlled by key policies and IAM policies  
• Can be rotated automatically (yearly) or manually  
• Full audit trail in CloudTrail for all usage  

#### Data Keys (DEKs - Data Encryption Keys)
• **Generated by KMS** but used outside KMS  
• Actual AES-256 symmetric keys that encrypt your data  
• KMS provides both:
  - Plaintext version (for immediate encryption use)
  - Encrypted version (for storage with encrypted data)
• Can encrypt unlimited amounts of data  
• No direct AWS management after generation  
• Never stored in plaintext, only in memory during use  

### Envelope Encryption Flow

#### Upload Flow with SSE-KMS
1. User initiates upload with KMS key ID
2. S3 calls **KMS GenerateDataKey** API:
   - Input: KMS key ARN + encryption context
   - Output: Plaintext data key + Encrypted data key
3. S3 uses **plaintext data key** to encrypt the object (AES-256)
4. S3 immediately **discards plaintext data key** from memory
5. S3 stores with the object:
   - The encrypted object data
   - The **encrypted data key** in object metadata
   - The encryption context in metadata
6. KMS never sees your actual data (only generates keys)

#### Download Flow with SSE-KMS
1. User requests the encrypted object
2. S3 retrieves from object metadata:
   - Encrypted data key
   - Original encryption context
3. S3 calls **KMS Decrypt** API:
   - Input: Encrypted data key + stored encryption context
   - Output: Plaintext data key
4. KMS validates permissions and context, returns plaintext data key
5. S3 uses **plaintext data key** to decrypt the object
6. S3 sends decrypted object to user
7. S3 **discards plaintext data key** from memory

### Encryption Context with ABAC

#### Upload Flow with Custom Encryption Context
• User provides custom context: `{"username_owner": "test_username_owner"}`  
• User base64-encodes the context for API call  
• S3 receives upload request with custom context  
• S3 **automatically adds** `"aws:s3:arn": "arn:aws:s3:::bucket/key"`  
• S3 calls KMS GenerateDataKey with combined context  
• KMS validates context against key policy conditions  
• S3 stores full encryption context with object metadata  

#### Download Flow - Context Handled Automatically
• User requests object (no context needed in request)  
• S3 retrieves stored encryption context from metadata  
• S3 **automatically** passes stored context to KMS Decrypt  
• KMS validates stored context against key policy  
• If authorized, KMS returns decrypted data key  
• S3 decrypts and returns object to user  

### Command Examples

#### Upload with Custom Encryption Context (s3api)
```python
import subprocess
import base64, json

# Create encryption context
encryption_context_dict = {
    'username_owner': 'test_username_owner'
}

# Base64 encode the context
b64_encryption_context_str = base64.b64encode(
    json.dumps(encryption_context_dict).encode('utf-8')
).decode('utf-8')

# Upload with s3api put-object
subprocess.run([
    'aws', 's3api', 'put-object',
    '--bucket', 'avijay-lab-2-sse-kms',
    '--key', 'upload_2.txt',
    '--body', './example_object.txt',
    '--server-side-encryption', 'aws:kms',
    '--ssekms-key-id', 'arn:aws:kms:us-east-1:957401190575:key/YOUR-KEY-ID',
    '--ssekms-encryption-context', b64_encryption_context_str
])
```

#### Failed Attempt with s3 cp (Does NOT Support Custom Context)
```bash
# This FAILS - s3 cp doesn't support custom encryption context
aws s3 cp ./example.txt s3://bucket/key \
  --sse aws:kms \
  --sse-kms-key-id arn:aws:kms:region:account:key/id \
  --sse-kms-context username_owner=value  # NOT SUPPORTED
```

#### Download (Simple - Context Handled Automatically)
```bash
# Works with s3 cp - S3 handles context automatically
aws s3 cp s3://avijay-lab-2-sse-kms/upload_2.txt ./downloaded.txt

# Or with s3api
aws s3api get-object \
  --bucket avijay-lab-2-sse-kms \
  --key upload_2.txt \
  downloaded.txt
```

### CloudTrail Logs

#### Upload - S3 PutObject Event
```json
{
    "eventVersion": "1.09",
    "userIdentity": {
        "type": "IAMUser",
        "principalId": "REDACTED_PRINCIPAL_ID",
        "arn": "arn:aws:iam::957401190575:user/iamadmin",
        "accountId": "957401190575",
        "accessKeyId": "REDACTED_ACCESS_KEY",
        "userName": "iamadmin"
    },
    "eventTime": "2025-08-12T01:01:18Z",
    "eventSource": "s3.amazonaws.com",
    "eventName": "PutObject",
    "awsRegion": "us-east-1",
    "sourceIPAddress": "64.250.227.85",
    "userAgent": "[aws-cli/2.26.3 Python/3.13.2 Darwin/24.4.0]",
    "requestParameters": {
        "bucketName": "avijay-lab-2-sse-kms",
        "key": "upload_2.txt",
        "x-amz-server-side-encryption": "aws:kms",
        "x-amz-server-side-encryption-aws-kms-key-id": "arn:aws:kms:us-east-1:957401190575:key/REDACTED_KEY_ID"
    },
    "responseElements": {
        "x-amz-server-side-encryption": "aws:kms",
        "x-amz-server-side-encryption-aws-kms-key-id": "arn:aws:kms:us-east-1:957401190575:key/REDACTED_KEY_ID"
    },
    "resources": [
        {
            "type": "AWS::S3::Bucket",
            "ARN": "arn:aws:s3:::avijay-lab-2-sse-kms"
        },
        {
            "type": "AWS::S3::Object",
            "ARN": "arn:aws:s3:::avijay-lab-2-sse-kms/upload_2.txt"
        }
    ]
}
```

#### Upload - KMS GenerateDataKey Event
```json
{
    "eventVersion": "1.11",
    "userIdentity": {
        "type": "IAMUser",
        "principalId": "REDACTED_PRINCIPAL_ID",
        "arn": "arn:aws:iam::957401190575:user/iamadmin",
        "accountId": "957401190575",
        "accessKeyId": "REDACTED_ACCESS_KEY",
        "userName": "iamadmin"
    },
    "eventTime": "2025-08-12T01:01:18Z",
    "eventSource": "kms.amazonaws.com",
    "eventName": "GenerateDataKey",
    "awsRegion": "us-east-1",
    "sourceIPAddress": "AWS Internal",
    "userAgent": "AWS Internal",
    "requestParameters": {
        "keySpec": "AES_256",
        "encryptionContext": {
            "username_owner": "test_username_owner",
            "aws:s3:arn": "arn:aws:s3:::avijay-lab-2-sse-kms/upload_2.txt"
        },
        "keyId": "arn:aws:kms:us-east-1:957401190575:key/REDACTED_KEY_ID"
    },
    "resources": [
        {
            "accountId": "957401190575",
            "type": "AWS::KMS::Key",
            "ARN": "arn:aws:kms:us-east-1:957401190575:key/REDACTED_KEY_ID"
        }
    ]
}
```

**Key Points:**
- `eventName`: "GenerateDataKey" - Creating new data key for encryption
- `encryptionContext`: Contains both custom `username_owner` and S3-added `aws:s3:arn`
- `keySpec`: "AES_256" - The data key algorithm

#### Download - S3 GetObject Event
```json
{
    "eventVersion": "1.11",
    "userIdentity": {
        "type": "IAMUser",
        "principalId": "REDACTED_PRINCIPAL_ID",
        "arn": "arn:aws:iam::957401190575:user/iamadmin",
        "accountId": "957401190575",
        "accessKeyId": "REDACTED_ACCESS_KEY",
        "userName": "iamadmin"
    },
    "eventTime": "2025-08-12T01:08:09Z",
    "eventSource": "s3.amazonaws.com",
    "eventName": "GetObject",
    "awsRegion": "us-east-1",
    "sourceIPAddress": "64.250.227.85",
    "userAgent": "[aws-cli/2.26.3 md/awscrt#0.25.4 ua/2.1 os/macos#24.4.0]",
    "requestParameters": {
        "bucketName": "avijay-lab-2-sse-kms",
        "key": "upload_2.txt"
    },
    "additionalEventData": {
        "SignatureVersion": "SigV4",
        "CipherSuite": "TLS_CHACHA20_POLY1305_SHA256",
        "bytesTransferredOut": 57,
        "x-amz-id-2": "REDACTED_REQUEST_ID"
    },
    "resources": [
        {
            "accountId": "957401190575",
            "type": "AWS::S3::Bucket",
            "ARN": "arn:aws:s3:::avijay-lab-2-sse-kms"
        },
        {
            "type": "AWS::S3::Object",
            "ARN": "arn:aws:s3:::avijay-lab-2-sse-kms/upload_2.txt"
        }
    ]
}
```

#### Download - KMS Decrypt Event
```json
{
    "eventVersion": "1.11",
    "userIdentity": {
        "type": "IAMUser",
        "principalId": "REDACTED_PRINCIPAL_ID",
        "arn": "arn:aws:iam::957401190575:user/iamadmin",
        "accountId": "957401190575",
        "accessKeyId": "REDACTED_ACCESS_KEY",
        "userName": "iamadmin"
    },
    "eventTime": "2025-08-12T01:08:09Z",
    "eventSource": "kms.amazonaws.com",
    "eventName": "Decrypt",
    "awsRegion": "us-east-1",
    "sourceIPAddress": "AWS Internal",
    "userAgent": "AWS Internal",
    "requestParameters": {
        "encryptionAlgorithm": "SYMMETRIC_DEFAULT",
        "encryptionContext": {
            "username_owner": "test_username_owner",
            "aws:s3:arn": "arn:aws:s3:::avijay-lab-2-sse-kms/upload_2.txt"
        }
    },
    "resources": [
        {
            "accountId": "957401190575",
            "type": "AWS::KMS::Key",
            "ARN": "arn:aws:kms:us-east-1:957401190575:key/REDACTED_KEY_ID"
        }
    ]
}
```

**Key Points:**
- `eventName`: "Decrypt" - Decrypting the stored data key
- `encryptionContext`: Automatically provided by S3 from object metadata
- User didn't need to specify context on download

### Security Benefits of This Architecture

#### Why Envelope Encryption?
• **Performance**: Large files encrypted with fast symmetric AES, not slow KMS API calls  
• **Security**: KMS key never exposed outside HSM, data key only in memory briefly  
• **Audit**: Every data key generation/decryption logged in CloudTrail  
• **Scale**: One KMS API call can encrypt/decrypt any size object  
• **Control**: Key policies govern who can generate/use data keys  

#### ABAC Implementation Benefits
• **Dynamic Access**: Users can only decrypt objects tagged with their username  
• **No Policy Updates**: New users automatically get correct permissions via tags  
• **Audit Trail**: CloudTrail shows who accessed what with full context  
• **Defense in Depth**: Requires both S3 and KMS permissions to work  

### Testing Checklist for ABAC with KMS

- [ ] Upload as `aalsg-user-1` with context `username_owner=aalsg-user-1`
- [ ] Verify encryption context in CloudTrail includes both custom and S3 values
- [ ] Download as same user - should succeed
- [ ] Try download as `aalsg-user-2` - should fail on KMS Decrypt
- [ ] Test without ViaService condition - ensure direct KMS API calls fail
- [ ] Verify S3 console upload doesn't work (no custom context support)
- [ ] Test key rotation - ensure old objects still decrypt

### Important Limitations

1. **S3 Console**: Cannot specify custom encryption context - must use CLI/SDK
2. **Complexity**: Requires programmatic access for uploads
3. **User Experience**: Standard S3 tools won't work for upload
4. **Key Policy**: Must be carefully crafted to check PrincipalTags
5. **Debugging**: Failures could be S3 permissions OR KMS permissions

### Critical Bucket Policy Bug Found

**Issue**: The bucket policy `ABACDenyUploadUnlessTaggedAsUser` statement incorrectly uses `s3:ExistingObjectTag` for PutObject operations.

**Problem**: According to [AWS S3 Tagging Documentation](https://docs.aws.amazon.com/AmazonS3/latest/userguide/tagging-and-policies.html):
- `s3:ExistingObjectTag` - Verifies tags on **existing** objects. **Cannot be used with PUT Object operations**.
- `s3:RequestObjectTag` - Restricts tags during object creation. **Should be used for PutObject with tagging**.

**Current (Broken) Condition**:
```json
"Condition": {
    "StringNotEquals": {
        "s3:ExistingObjectTag/username_owner": "${aws:PrincipalTag/username_owner}"
    }
}
```

**Correct Condition**:
```json
"Condition": {
    "StringNotEquals": {
        "s3:RequestObjectTag/username_owner": "${aws:PrincipalTag/username_owner}"
    }
}
```

**Why PutObject Still Works**: The broken condition likely doesn't evaluate properly for new objects, so the Deny doesn't trigger. The IAM inline policy's explicit Allow for PutObject takes effect instead.

### Best Practices

1. Always use `ViaService` condition to prevent direct KMS usage
2. Include explicit Deny statements for non-matching contexts
3. Test with CloudTrail logging enabled to debug issues
4. Document the required upload process for users
5. Consider Lambda functions to simplify the upload process
6. Use separate KMS keys per security boundary/use case